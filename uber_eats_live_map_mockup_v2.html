<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Uber Eats Live Map - Interactive Mockup (v2)</title>

  <!-- Leaflet (map) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    :root{
      --bg: #0b0d12;
      --panel: rgba(16, 18, 26, 0.84);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.62);
      --stroke: rgba(255,255,255,0.12);

      --good: rgba(120,255,190,0.92);
      --warn: rgba(255,205,80,0.92);
      --danger: rgba(255,90,90,0.92);

      --radius: 18px;
      --shadow: 0 16px 50px rgba(0,0,0,0.38);
    }

    *{ box-sizing: border-box; }
    html, body { height: 100%; margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji"; background: var(--bg); }
    #app { height: 100%; width: 100%; position: relative; overflow: hidden; }

    /* IMPORTANT: keep #map clean (Leaflet owns its DOM). Put overlays OUTSIDE of #map. */
    #map { height: 100%; width: 100%; }

    /* Soft "vibe haze" overlay (non-interactive) */
    #hazeOverlay{
      position:absolute; inset: 0;
      pointer-events:none;
      z-index: 300; /* above tiles, below UI */
      mix-blend-mode: screen;
      opacity: 0.9;
    }

    @keyframes driftA { 0%{ transform: translate(-20px, 10px) } 50%{ transform: translate(30px, -20px) } 100%{ transform: translate(-20px, 10px) } }
    @keyframes driftB { 0%{ transform: translate(25px, -10px) } 50%{ transform: translate(-25px, 25px) } 100%{ transform: translate(25px, -10px) } }

    #hazeOverlay::before,
    #hazeOverlay::after{
      content:"";
      position:absolute;
      width: 520px; height: 520px;
      border-radius: 50%;
      background: radial-gradient(circle at 35% 35%, rgba(140, 210, 255, 0.16) 0%, rgba(140, 210, 255, 0.07) 35%, transparent 65%);
      filter: blur(1px);
      opacity: 0.7;
    }
    #hazeOverlay::before{
      top: 10%; left: 18%;
      animation: driftA 14s ease-in-out infinite;
    }
    #hazeOverlay::after{
      bottom: 8%; right: 14%;
      width: 620px; height: 620px;
      background: radial-gradient(circle at 45% 45%, rgba(170, 240, 255, 0.12) 0%, rgba(170, 240, 255, 0.05) 35%, transparent 66%);
      animation: driftB 18s ease-in-out infinite;
    }

    /* UI scaffolding */
    .ui{
      position:absolute; inset: 12px 12px auto 12px;
      display:flex; align-items:flex-start; justify-content:space-between; gap: 12px;
      z-index: 900;
      pointer-events:none;
    }
    .card{
      pointer-events:auto;
      background: var(--panel);
      color: var(--text);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }

    .brand{
      padding: 12px 14px;
      display:flex; gap: 10px; align-items:center;
      min-width: 260px;
    }
    .dot{
      width: 10px; height: 10px; border-radius: 999px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.95), rgba(255,255,255,0.12));
      border: 1px solid rgba(255,255,255,0.18);
      box-shadow: 0 0 18px rgba(255,255,255,0.14);
      flex: 0 0 auto;
    }
    .brand h1{
      font-size: 13px; margin: 0; letter-spacing: 0.2px; line-height: 1.2;
    }
    .brand p{
      font-size: 12px; margin: 3px 0 0; color: var(--muted);
    }

    .controls{
      padding: 12px;
      width: min(520px, calc(100vw - 24px));
    }
    .label{ font-size: 12px; color: var(--muted); margin-bottom: 6px; }
    .section{ margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.10); }

    .pillbar{
      display:flex; gap: 8px; overflow-x:auto; padding-bottom: 2px;
      scrollbar-width: none;
    }
    .pillbar::-webkit-scrollbar{ display:none; }

    .pill{
      flex: 0 0 auto;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      color: var(--text);
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 12px;
      cursor: pointer;
      user-select:none;
      transition: transform 120ms ease, background 120ms ease, border 120ms ease;
      white-space: nowrap;
    }
    .pill:hover{ transform: translateY(-1px); background: rgba(255,255,255,0.09); }
    .pill.active{
      background: rgba(255,255,255,0.14);
      border-color: rgba(255,255,255,0.24);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.08);
    }

    .row{ display:flex; gap: 10px; align-items:center; flex-wrap:wrap; }

    select{
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.14);
      color: var(--text);
      border-radius: 12px;
      padding: 8px 10px;
      font-size: 12px;
      outline: none;
    }

    .toggle{
      display:flex; align-items:center; gap: 8px;
      padding: 6px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      cursor:pointer; user-select:none;
      font-size: 12px;
    }
    .toggle input{ accent-color: white; }

    .note{
      margin-top: 8px;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.10);
      color: var(--muted);
      font-size: 12px;
      line-height: 1.35;
    }

    /* Right drawer */
    .drawer{
      position:absolute;
      top: 12px; right: 12px; bottom: 12px;
      width: min(380px, calc(100vw - 24px));
      z-index: 950;
      transform: translateX(calc(100% + 16px));
      transition: transform 220ms ease;
      display:flex; flex-direction:column;
    }
    .drawer.open{ transform: translateX(0); }
    .drawerHeader{
      padding: 14px 14px 10px;
      border-bottom: 1px solid rgba(255,255,255,0.10);
    }
    .drawerHeader .title{
      display:flex; align-items:flex-start; justify-content:space-between; gap: 10px;
    }
    .drawerHeader h2{ margin:0; font-size: 16px; letter-spacing: 0.2px; }
    .drawerHeader .sub{ margin: 6px 0 0; font-size: 12px; color: var(--muted); line-height: 1.35; }
    .xbtn{
      border:none; background: rgba(255,255,255,0.10); color: var(--text);
      width: 34px; height: 34px; border-radius: 12px; cursor:pointer;
      display:grid; place-items:center;
    }
    .drawerBody{
      padding: 12px 14px;
      overflow:auto;
      display:flex; flex-direction:column; gap: 12px;
    }
    .kpiGrid{
      display:grid; grid-template-columns: 1fr 1fr; gap: 10px;
    }
    .kpi{
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
    }
    .kpi .k{ font-size: 11px; color: var(--muted); margin-bottom: 4px; }
    .kpi .v{ font-size: 15px; }

    .list{
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.12);
      overflow:hidden;
      background: rgba(255,255,255,0.04);
    }
    .listItem{
      padding: 10px 12px;
      border-top: 1px solid rgba(255,255,255,0.08);
      display:flex; align-items:center; justify-content:space-between; gap: 8px;
      font-size: 12px;
    }
    .listItem:first-child{ border-top:none; }
    .tag{
      font-size: 11px;
      color: rgba(255,255,255,0.85);
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.08);
      white-space: nowrap;
    }

    .ctaRow{ display:flex; gap: 10px; }
    .btn{
      flex:1;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.10);
      color: var(--text);
      cursor:pointer;
      font-size: 12px;
    }
    .btn.primary{
      background: rgba(255,255,255,0.16);
      border-color: rgba(255,255,255,0.22);
    }

    /* Bottom route widget */
    .routebar{
      position:absolute; left: 12px; right: 12px; bottom: 12px;
      z-index: 920;
      padding: 10px 12px;
      display:flex; gap: 10px; align-items:center; justify-content:space-between;
    }
    .routebar .left{ display:flex; flex-direction:column; gap: 3px; }
    .routebar .t{ font-size: 12px; color: var(--text); }
    .routebar .m{ font-size: 12px; color: var(--muted); }
    .routebar .actions{ display:flex; gap: 8px; }
    .routePill{
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      color: var(--text);
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 12px;
      cursor:pointer;
      user-select:none;
    }

    /* Legend */
    .legend{
      position:absolute; left: 12px; bottom: 76px;
      z-index: 910;
      padding: 10px 12px;
      width: min(260px, calc(100vw - 24px));
    }
    .legend .title{ font-size: 12px; color: var(--text); margin-bottom: 8px; }
    .legend .item{ display:flex; align-items:center; gap: 8px; font-size: 12px; color: var(--muted); margin-bottom: 6px; }
    .swatch{ width: 10px; height: 10px; border-radius: 999px; border: 1px solid rgba(255,255,255,0.14); }

    /* Leaflet controls */
    .leaflet-control-container .leaflet-control{
      border-radius: 14px;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,0.14);
      box-shadow: 0 8px 24px rgba(0,0,0,0.25);
      background: rgba(16, 18, 26, 0.86);
    }
    .leaflet-control-zoom a{
      background: rgba(16, 18, 26, 0.86) !important;
      color: rgba(255,255,255,0.9) !important;
      border-bottom: 1px solid rgba(255,255,255,0.10) !important;
    }
    .leaflet-control-attribution{
      background: rgba(16, 18, 26, 0.70) !important;
      color: rgba(255,255,255,0.70) !important;
      border-top: 1px solid rgba(255,255,255,0.10);
    }
    .leaflet-control-attribution a{ color: rgba(255,255,255,0.85) !important; }

    /* Mobile drawer becomes bottom sheet */
    @media (max-width: 880px){
      .drawer{ top: auto; height: min(68vh, 560px); width: calc(100vw - 24px); right: 12px; left: 12px; }
      .drawer{ transform: translateY(calc(100% + 16px)); }
      .drawer.open{ transform: translateY(0); }
      .legend{ display:none; }
      .routebar{ bottom: 12px; }
      .ui{ flex-direction:column; align-items:stretch; }
      .controls{ width: 100%; }
      .brand{ width: fit-content; }
    }
  </style>
</head>

<body>
<div id="app">
  <div id="map" aria-label="Map"></div>
  <div id="hazeOverlay" aria-hidden="true"></div>

  <div class="ui">
    <div class="card brand">
      <div class="dot"></div>
      <div>
        <h1>Live Food Map (Mockup)</h1>
        <p>Shows trends, not people. Tap a bubble.</p>
      </div>
    </div>

    <div class="card controls">
      <div class="label">Campus / neighborhood</div>
      <div class="pillbar" id="campusBar"></div>

      <div class="section">
        <div class="row">
          <div style="flex:1; min-width: 200px;">
            <div class="label">Mode</div>
            <div class="pillbar" id="modeBar"></div>
          </div>

          <div style="min-width: 200px;">
            <div class="label">Time window</div>
            <div class="pillbar" id="windowBar"></div>
          </div>
        </div>

        <div class="row" style="margin-top: 10px;">
          <div>
            <div class="label">Color shows</div>
            <select id="colorBy">
              <option value="speed">Speed reliability</option>
              <option value="reorder">Repeat orders</option>
              <option value="deal">Deals</option>
            </select>
          </div>

          <label class="toggle" title="Emphasize restaurants that have a deal right now (including campus deals).">
            <input type="checkbox" id="dealsOnly" />
            Deals highlight
          </label>

          <label class="toggle" title="Pickup-first + scheduled framing (suburban example).">
            <input type="checkbox" id="suburbanMode" />
            Suburban mode
          </label>
        </div>

        <div class="note" id="systemNote">
          <b>Idea:</b> make the map the homepage for restaurant discovery. Bubble size = recent orders.
        </div>
      </div>
    </div>
  </div>

  <div class="card legend" id="legend">
    <div class="title">Legend</div>
    <div class="item"><span class="swatch" style="background: var(--good)"></span> Usually fast / reliable</div>
    <div class="item"><span class="swatch" style="background: var(--warn)"></span> Mixed timing</div>
    <div class="item"><span class="swatch" style="background: var(--danger)"></span> Timing varies</div>
    <div class="item"><span class="swatch" style="background: rgba(255,255,255,0.22)"></span> Bubble size = recent activity</div>
  </div>

  <div class="card drawer" id="drawer" aria-label="Restaurant details">
    <div class="drawerHeader">
      <div class="title">
        <div>
          <h2 id="dName">Select a restaurant</h2>
          <div class="sub" id="dSub">Tap a bubble on the map.</div>
        </div>
        <button class="xbtn" id="closeDrawer" title="Close">‚úï</button>
      </div>
    </div>

    <div class="drawerBody">
      <div class="kpiGrid">
        <div class="kpi">
          <div class="k">ETA (honest range)</div>
          <div class="v" id="dEta">‚Äî</div>
        </div>
        <div class="kpi">
          <div class="k">Usually on time</div>
          <div class="v" id="dOnTime">‚Äî</div>
        </div>
        <div class="kpi">
          <div class="k">Recent orders</div>
          <div class="v" id="dOrders">‚Äî</div>
        </div>
        <div class="kpi">
          <div class="k">Repeat order rate</div>
          <div class="v" id="dReorder">‚Äî</div>
        </div>
      </div>

      <div class="list">
        <div class="listItem">
          <span>Best-seller</span>
          <span class="tag" id="dBestseller">‚Äî</span>
        </div>
        <div class="listItem">
          <span>Deal right now</span>
          <span class="tag" id="dDeal">‚Äî</span>
        </div>
        <div class="listItem">
          <span>Good for</span>
          <span class="tag" id="dGoodFor">‚Äî</span>
        </div>
      </div>

      <div class="ctaRow">
        <button class="btn primary" id="orderBtn">Place order (mock)</button>
        <button class="btn" id="boostBtn">Boost my bubble (merchant)</button>
      </div>

      <div class="card" style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.10); border-radius: 14px; padding: 12px;">
        <div class="label" style="margin:0 0 6px;">Merchant view (heatmap idea)</div>
        <div style="font-size:12px; color: var(--muted); line-height:1.35;">
          When demand clusters nearby, a local restaurant can staff smarter and run deals that actually help.
        </div>
        <div id="ownerBars" style="margin-top:10px; display:flex; flex-direction:column; gap: 8px;"></div>
      </div>
    </div>
  </div>

  <div class="card routebar" id="routebar">
    <div class="left">
      <div class="t"><b>Ride + Pickup</b> (mock)</div>
      <div class="m" id="routeText">Select a restaurant to preview a pickup stop on your way ‚Äúhome.‚Äù</div>
    </div>
    <div class="actions">
      <div class="routePill" id="previewRoute">Preview route</div>
      <div class="routePill" id="clearRoute">Clear</div>
    </div>
  </div>
</div>

<script>
  const CAMPUSES = [
    {
      id: "yale",
      name: "Yale / New Haven",
      center: [41.3083, -72.9279],
      zoom: 14,
      campusCenter: [41.3083, -72.9279],
      campusRadiusMeters: 1200,
      restaurants: [
        { id:"tomo", name:"Tomo Ramen", lat:41.3097, lng:-72.9252, eta:[22,34], onTime:0.91, reorder:0.38, orders30:68, orders60:122, deal:"10% off with Yale email", dealType:"campus", best:"Spicy miso ramen", goodFor:"Late-night", tags:["Japanese"] },
        { id:"claires", name:"Claire‚Äôs Corner Copia", lat:41.3089, lng:-72.9292, eta:[18,28], onTime:0.89, reorder:0.44, orders30:54, orders60:97, deal:"Free cookie over $25", dealType:"public", best:"Falafel wrap", goodFor:"Vegetarian", tags:["Mediterranean"] },
        { id:"salsas3", name:"Salsa‚Äôs III", lat:41.3062, lng:-72.9273, eta:[20,32], onTime:0.84, reorder:0.33, orders30:40, orders60:81, deal:"$3 off burrito bowl (5‚Äì7pm)", dealType:"public", best:"Carnitas burrito", goodFor:"Group order", tags:["Mexican"] },
        { id:"junzi", name:"Junzi Kitchen", lat:41.3105, lng:-72.9272, eta:[16,24], onTime:0.93, reorder:0.41, orders30:76, orders60:140, deal:"No deal", dealType:"none", best:"Dan dan noodles", goodFor:"Quick lunch", tags:["Chinese"] },
        { id:"k-bbq", name:"K-BBQ Bento", lat:41.3121, lng:-72.9340, eta:[26,40], onTime:0.78, reorder:0.29, orders30:28, orders60:55, deal:"BOGO side after 9pm", dealType:"public", best:"Bulgogi bowl", goodFor:"Post-practice", tags:["Korean"] },
        { id:"zeneli", name:"Zeneli Pizza", lat:41.3080, lng:-72.9198, eta:[24,36], onTime:0.86, reorder:0.36, orders30:46, orders60:88, deal:"No deal", dealType:"none", best:"Margherita", goodFor:"Friends", tags:["Pizza"] },
      ]
    },
    {
      id: "harvard",
      name: "Harvard / Cambridge",
      center: [42.3736, -71.1189],
      zoom: 14,
      campusCenter: [42.3736, -71.1189],
      campusRadiusMeters: 1300,
      restaurants: [
        { id:"felipes", name:"Felipe‚Äôs Taqueria", lat:42.3720, lng:-71.1195, eta:[18,30], onTime:0.88, reorder:0.42, orders30:72, orders60:138, deal:"Student combo $2 off", dealType:"campus", best:"Steak burrito", goodFor:"Late-night", tags:["Mexican"] },
        { id:"tatte", name:"Tatte Bakery", lat:42.3728, lng:-71.1217, eta:[15,24], onTime:0.92, reorder:0.46, orders30:61, orders60:121, deal:"Free coffee with pastry (2‚Äì4pm)", dealType:"public", best:"Shakshuka", goodFor:"Brunch", tags:["Cafe"] },
        { id:"ichiban", name:"Ichiban Sushi", lat:42.3699, lng:-71.1146, eta:[22,36], onTime:0.83, reorder:0.35, orders30:35, orders60:70, deal:"No deal", dealType:"none", best:"Salmon roll", goodFor:"Light dinner", tags:["Sushi"] },
        { id:"raising", name:"Raising Cane‚Äôs", lat:42.3668, lng:-71.1030, eta:[20,34], onTime:0.85, reorder:0.33, orders30:49, orders60:95, deal:"No deal", dealType:"none", best:"Box combo", goodFor:"Quick bite", tags:["Chicken"] },
      ]
    },
    {
      id: "suburb",
      name: "Suburban demo (pickup-first)",
      center: [41.3430, -72.9620],
      zoom: 13,
      campusCenter: [41.3430, -72.9620],
      campusRadiusMeters: 1800,
      restaurants: [
        { id:"localthai", name:"Local Thai Kitchen", lat:41.3506, lng:-72.9690, eta:[35,55], onTime:0.87, reorder:0.40, orders30:16, orders60:32, deal:"$5 off pickup over $30", dealType:"public", best:"Pad kee mao", goodFor:"Family", tags:["Thai"] },
        { id:"greek", name:"Niko‚Äôs Greek Grill", lat:41.3386, lng:-72.9547, eta:[30,50], onTime:0.82, reorder:0.31, orders30:12, orders60:26, deal:"No deal", dealType:"none", best:"Chicken gyro", goodFor:"Pickup", tags:["Greek"] },
        { id:"bagel", name:"Bagels & Brew", lat:41.3428, lng:-72.9992, eta:[28,44], onTime:0.90, reorder:0.37, orders30:10, orders60:20, deal:"Breakfast bundle (weekday)", dealType:"public", best:"Egg sandwich", goodFor:"Morning", tags:["Cafe"] },
        { id:"bbq", name:"Backyard BBQ", lat:41.3589, lng:-72.9426, eta:[40,65], onTime:0.79, reorder:0.28, orders30:8, orders60:15, deal:"Neighborhood deal: free drink", dealType:"public", best:"Pulled pork", goodFor:"Game night", tags:["BBQ"] },
      ]
    }
  ];

  const state = {
    campusId: "yale",
    mode: "delivery",
    window: 30,
    colorBy: "speed",
    dealsHighlight: false,
    suburbanMode: false,
    selectedId: null,
  };

  const map = L.map('map', { zoomControl: true, preferCanvas: false });

  const darkTiles = L.tileLayer(
    'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
    { subdomains: 'abcd', maxZoom: 20, attribution: '&copy; OpenStreetMap contributors &copy; CARTO' }
  );
  darkTiles.addTo(map);

  L.control.attribution({ prefix: false }).addTo(map);

  let bubbleLayer = L.layerGroup().addTo(map);
  let routeLayer = L.layerGroup().addTo(map);

  const HOME_POINTS = {
    yale: [41.3137, -72.9300],
    harvard: [42.3663, -71.1068],
    suburb: [41.3310, -72.9750]
  };

  const clamp = (x, a, b) => Math.max(a, Math.min(b, x));

  function getCampus(){
    return CAMPUSES.find(c => c.id === state.campusId) || CAMPUSES[0];
  }

  function isCampusDeal(campus, r){
    if(r.dealType !== "campus") return false;
    const d = map.distance([r.lat, r.lng], campus.campusCenter);
    return d <= campus.campusRadiusMeters;
  }

  function getRecentOrders(r){
    return state.window === 30 ? r.orders30 : r.orders60;
  }

  function radiusFromOrders(orders){
    return clamp(10 + Math.sqrt(orders) * 2.2, 12, 44);
  }

  function colorForRestaurant(campus, r){
    if(state.colorBy === "deal"){
      const hasDeal = (r.dealType !== "none");
      const campusDeal = isCampusDeal(campus, r);
      if(campusDeal) return "rgba(160, 240, 255, 0.92)";
      return hasDeal ? "rgba(255, 240, 160, 0.92)" : "rgba(255,255,255,0.20)";
    }

    if(state.colorBy === "reorder"){
      const t = clamp((r.reorder - 0.20) / (0.55 - 0.20), 0, 1);
      const a = 0.85;
      const rC = Math.round(180 + 60 * t);
      const gC = Math.round(200 + 40 * t);
      const bC = 255;
      return `rgba(${rC}, ${gC}, ${bC}, ${a})`;
    }

    if(r.onTime >= 0.90) return "rgba(120,255,190,0.92)";
    if(r.onTime >= 0.83) return "rgba(255,205,80,0.92)";
    return "rgba(255,90,90,0.92)";
  }

  function borderStyleForRestaurant(campus, r){
    const hasDeal = r.dealType !== "none";
    const campusDeal = isCampusDeal(campus, r);
    if(state.dealsHighlight && (hasDeal || campusDeal)){
      return { weight: 2.6, opacity: 0.95 };
    }
    return { weight: 1.0, opacity: 0.50 };
  }

  function shouldDimRestaurant(campus, r){
    if(!state.dealsHighlight) return false;
    const hasDeal = r.dealType !== "none";
    const campusDeal = isCampusDeal(campus, r);
    return !(hasDeal || campusDeal);
  }

  function formatPct(x){ return `${Math.round(x*100)}%`; }
  function etaText(eta){ return `${eta[0]}‚Äì${eta[1]} min`; }

  function setDrawerOpen(open){
    document.getElementById("drawer").classList.toggle("open", open);
  }

  function setSelected(r){
    state.selectedId = r?.id || null;
    if(!r){ setDrawerOpen(false); return; }

    const campus = getCampus();
    const campusDeal = isCampusDeal(campus, r);
    const dealText = campusDeal ? `üéì ${r.deal}` : (r.dealType === "none" ? "No deal" : r.deal);

    document.getElementById("dName").textContent = r.name;
    document.getElementById("dSub").textContent = `${r.tags.join(" ‚Ä¢ ")} ‚Ä¢ ${state.mode.toUpperCase()}`;
    document.getElementById("dEta").textContent = etaText(r.eta);
    document.getElementById("dOnTime").textContent = formatPct(r.onTime);
    document.getElementById("dOrders").textContent = `${getRecentOrders(r)} in last ${state.window} min`;
    document.getElementById("dReorder").textContent = formatPct(r.reorder);
    document.getElementById("dBestseller").textContent = r.best;
    document.getElementById("dDeal").textContent = dealText;
    document.getElementById("dGoodFor").textContent = r.goodFor;

    const ownerBars = document.getElementById("ownerBars");
    ownerBars.innerHTML = "";
    const base = getRecentOrders(r);
    const hours = [
      {h:"5pm", w:0.55}, {h:"6pm", w:0.85}, {h:"7pm", w:1.00},
      {h:"8pm", w:0.92}, {h:"9pm", w:0.72}, {h:"10pm", w:0.52}
    ];
    hours.forEach(obj=>{
      const val = Math.round(base * obj.w);

      const row = document.createElement("div");
      row.style.display = "flex";
      row.style.alignItems = "center";
      row.style.gap = "10px";

      const label = document.createElement("div");
      label.textContent = obj.h;
      label.style.width = "40px";
      label.style.fontSize = "12px";
      label.style.color = "rgba(255,255,255,0.65)";

      const bar = document.createElement("div");
      bar.style.flex = "1";
      bar.style.height = "10px";
      bar.style.borderRadius = "999px";
      bar.style.border = "1px solid rgba(255,255,255,0.12)";
      bar.style.background = "rgba(255,255,255,0.06)";
      bar.style.overflow = "hidden";

      const fill = document.createElement("div");
      fill.style.height = "100%";
      fill.style.width = `${clamp(val / (base*1.05) * 100, 8, 100)}%`;
      fill.style.background = "rgba(255,255,255,0.28)";
      fill.style.borderRadius = "999px";
      bar.appendChild(fill);

      const num = document.createElement("div");
      num.textContent = `${val}`;
      num.style.width = "42px";
      num.style.textAlign = "right";
      num.style.fontSize = "12px";
      num.style.color = "rgba(255,255,255,0.85)";

      row.appendChild(label);
      row.appendChild(bar);
      row.appendChild(num);
      ownerBars.appendChild(row);
    });

    setDrawerOpen(true);
  }

  function renderPills(containerId, items, activeId, onClick){
    const el = document.getElementById(containerId);
    el.innerHTML = "";
    items.forEach(item=>{
      const b = document.createElement("div");
      b.className = "pill" + (item.id === activeId ? " active" : "");
      b.textContent = item.label;
      b.onclick = () => onClick(item.id);
      el.appendChild(b);
    });
  }

  function syncControls(){
    document.getElementById("colorBy").value = state.colorBy;
    document.getElementById("dealsOnly").checked = state.dealsHighlight;
    document.getElementById("suburbanMode").checked = state.suburbanMode;

    renderPills("campusBar", CAMPUSES.map(c => ({id:c.id, label:c.name})), state.campusId, (id)=>{
      state.campusId = id;
      state.suburbanMode = (id === "suburb");
      syncControls();
      renderAll(true);
    });

    renderPills("modeBar", [
      {id:"delivery", label:"Delivery"},
      {id:"pickup", label:"Pickup"},
      {id:"dineout", label:"Dine-out"},
    ], state.mode, (id)=>{
      state.mode = id;
      renderAll(false);
    });

    renderPills("windowBar", [
      {id:30, label:"Last 30 min"},
      {id:60, label:"Last 60 min"},
    ], state.window, (id)=>{
      state.window = Number(id);
      renderAll(false);
    });
  }

  function renderAll(refocus){
    const campus = getCampus();

    if(refocus){
      map.setView(campus.center, campus.zoom);
      setSelected(null);
      clearRoute();
    }

    const systemNote = document.getElementById("systemNote");
    systemNote.innerHTML = state.suburbanMode
      ? "<b>Suburban mode:</b> pickup-first discovery + scheduled delivery framing."
      : "<b>Idea:</b> bubble size = recent orders. Color = reliability / repeat / deals.";

    bubbleLayer.clearLayers();

    campus.restaurants.forEach(r=>{
      const orders = getRecentOrders(r);
      const rad = radiusFromOrders(orders);
      const color = colorForRestaurant(campus, r);
      const border = borderStyleForRestaurant(campus, r);
      const dim = shouldDimRestaurant(campus, r);

      const haze = L.circleMarker([r.lat, r.lng], {
        radius: rad * 2.0,
        stroke: false,
        fillColor: color,
        fillOpacity: dim ? 0.02 : 0.10,
        interactive: false
      });

      const bubble = L.circleMarker([r.lat, r.lng], {
        radius: rad,
        color: `rgba(255,255,255,${border.opacity})`,
        weight: border.weight,
        fillColor: color,
        fillOpacity: dim ? 0.10 : 0.34,
        interactive: true
      });

      bubble.on("click", () => setSelected(r));
      bubble.bindTooltip(
        `<b>${r.name}</b><br/>${orders} orders ‚Ä¢ ${etaText(r.eta)}`,
        { direction: "top", offset: [0, -10], opacity: 0.95 }
      );

      bubbleLayer.addLayer(haze);
      bubbleLayer.addLayer(bubble);
    });
  }

  function previewRoute(){
    const campus = getCampus();
    const r = campus.restaurants.find(x => x.id === state.selectedId);
    if(!r){
      document.getElementById("routeText").textContent = "Select a restaurant to preview a pickup stop on your way ‚Äúhome.‚Äù";
      return;
    }

    routeLayer.clearLayers();

    const start = campus.center;
    const stop = [r.lat, r.lng];
    const home = HOME_POINTS[campus.id] || campus.center;

    routeLayer.addLayer(L.polyline([start, stop, home], {
      color: "rgba(255,255,255,0.85)",
      weight: 3,
      opacity: 0.75
    }));

    const mk = (pt) => L.circleMarker(pt, { radius: 6, color: "rgba(255,255,255,0.75)", weight: 2, fillColor:"rgba(255,255,255,0.75)", fillOpacity: 0.28 });
    routeLayer.addLayer(mk(start)); routeLayer.addLayer(mk(stop)); routeLayer.addLayer(mk(home));

    document.getElementById("routeText").textContent =
      `Add a pickup stop at ${r.name} on the way home (mock route).`;
  }

  function clearRoute(){
    routeLayer.clearLayers();
    document.getElementById("routeText").textContent =
      "Select a restaurant to preview a pickup stop on your way ‚Äúhome.‚Äù";
  }

  document.getElementById("colorBy").addEventListener("change", (e)=>{
    state.colorBy = e.target.value;
    renderAll(false);
  });

  document.getElementById("dealsOnly").addEventListener("change", (e)=>{
    state.dealsHighlight = e.target.checked;
    renderAll(false);
  });

  document.getElementById("suburbanMode").addEventListener("change", (e)=>{
    state.suburbanMode = e.target.checked;
    if(state.suburbanMode){
      state.campusId = "suburb";
    } else if(state.campusId === "suburb"){
      state.campusId = "yale";
    }
    syncControls();
    renderAll(true);
  });

  document.getElementById("closeDrawer").addEventListener("click", ()=> setSelected(null));

  document.getElementById("orderBtn").addEventListener("click", ()=>{
    const campus = getCampus();
    const r = campus.restaurants.find(x => x.id === state.selectedId);
    if(!r) return;
    alert(`Mock order placed at "${r.name}".

In the real product, this would go to checkout with a clean fee/ETA view.`);
  });

  document.getElementById("boostBtn").addEventListener("click", ()=>{
    const campus = getCampus();
    const r = campus.restaurants.find(x => x.id === state.selectedId);
    if(!r) return;
    const defaultObjective = state.suburbanMode ? "Fill off-peak pickup" : "Get new nearby customers";
    alert(
      `Boost my bubble (mock)

Restaurant: ${r.name}
Suggested objective: ${defaultObjective}

Choose: radius + time window + budget

(Real product: merchant panel + map preview + expected incremental orders.)`
    );
  });

  document.getElementById("previewRoute").addEventListener("click", previewRoute);
  document.getElementById("clearRoute").addEventListener("click", clearRoute);

  syncControls();
  renderAll(true);
</script>

</body>
</html>
